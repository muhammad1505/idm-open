name: Android E2E Test & Release

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  e2e-test-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          link-to-sdk: true

      - name: Install Rust Targets
        run: |
          rustup target add x86_64-linux-android aarch64-linux-android
          cargo install cargo-ndk

      - name: Prepare Flutter Project
        run: |
          mkdir -p ui_app
          cp -r ui/* ui_app/
          cd ui_app
          flutter create --platforms android --project-name idm_open --org com.idmopen .
          
          # Inject Permissions
          manifest="android/app/src/main/AndroidManifest.xml"
          sed -i '/<application/ i\    <uses-permission android:name="android.permission.INTERNET"/>' "$manifest"
          sed -i '/<application/ i\    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>' "$manifest"
          sed -i '/<application/ i\    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>' "$manifest"
          
          # Fix minSdk for permission_handler (needs 21+)
          if [ -f "android/app/build.gradle" ]; then
            sed -i 's/minSdkVersion .*/minSdkVersion 21/' android/app/build.gradle
          elif [ -f "android/app/build.gradle.kts" ]; then
            # Kotlin DSL usually uses: minSdk = ... or minSdkVersion(21)
            # Flutter template uses: minSdkVersion = flutter.minSdkVersion
            # We replace it with 21
            sed -i 's/minSdk.*/minSdk = 21/' android/app/build.gradle.kts
          fi

      - name: Build Rust FFI (x86_64 for Emulator)
        run: |
          cargo ndk -t x86_64 -o ui_app/android/app/src/main/jniLibs build -p idm-core-ffi --release

      - name: Build Rust FFI (arm64 for Release)
        run: |
          cargo ndk -t arm64-v8a -o ui_app/android/app/src/main/jniLibs build -p idm-core-ffi --release

      - name: Run Integration Test (Emulator)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          script: |
            # Smart background task: Wait for app install, then grant permissions
            nohup sh -c "while ! adb shell pm list packages | grep -q com.idmopen; do sleep 2; done; sleep 5; adb shell pm grant com.idmopen android.permission.WRITE_EXTERNAL_STORAGE; adb shell pm grant com.idmopen android.permission.READ_EXTERNAL_STORAGE" >/dev/null 2>&1 &

            # Run test
            cd ui_app && flutter test integration_test/app_test.dart

      - name: Build Release APK
        if: success()
        run: |
          cd ui_app
          flutter build apk --release

      - name: Upload Release APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: idm-open-release-apk
          path: ui_app/build/app/outputs/flutter-apk/app-release.apk
