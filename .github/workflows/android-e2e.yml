name: Android E2E Test & Release

on:
  push:
    branches: [main]
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  e2e-test-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          link-to-sdk: true

      - name: Install Rust Targets (x86_64)
        run: |
          rustup target add x86_64-linux-android

      - name: Install Rust Targets (arm64)
        if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
        run: |
          rustup target add aarch64-linux-android

      - name: Install cargo-ndk
        run: |
          command -v cargo-ndk >/dev/null || cargo install cargo-ndk --version 4.1.2 --locked

      - name: Prepare Flutter Project
        run: |
          mkdir -p ui_app
          cp -r ui/* ui_app/
          cd ui_app
          flutter create --platforms android --project-name idm_open --org com.idmopen .
          
          # Inject Permissions
          manifest="android/app/src/main/AndroidManifest.xml"
          sed -i '/<application/ i\    <uses-permission android:name="android.permission.INTERNET"/>' "$manifest"
          sed -i '/<application/ i\    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>' "$manifest"
          sed -i '/<application/ i\    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>' "$manifest"
          
          # Fix minSdk for permission_handler (needs 21+)
          if [ -f "android/app/build.gradle" ]; then
            sed -i 's/minSdkVersion .*/minSdkVersion 21/' android/app/build.gradle
          elif [ -f "android/app/build.gradle.kts" ]; then
            # Kotlin DSL usually uses: minSdk = ... or minSdkVersion(21)
            # Flutter template uses: minSdkVersion = flutter.minSdkVersion
            # We replace it with 21
            sed -i 's/minSdk.*/minSdk = 21/' android/app/build.gradle.kts
          fi

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('ui_app/android/**/build.gradle*', 'ui_app/android/**/settings.gradle*', 'ui_app/android/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Rust FFI
        run: |
          targets="-t x86_64"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.ref }}" == refs/tags/* ]]; then
            targets="$targets -t arm64-v8a"
          fi
          cargo ndk $targets -o ui_app/android/app/src/main/jniLibs build -p idm-core-ffi --release

      - name: Run Integration Test (Emulator)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 28
          target: default
          arch: x86_64
          script: |
            # Smart background task: Wait for app install, then grant permissions
            nohup sh -c "while ! adb shell pm list packages | grep -q com.idmopen; do sleep 2; done; sleep 5; adb shell pm grant com.idmopen android.permission.WRITE_EXTERNAL_STORAGE; adb shell pm grant com.idmopen android.permission.READ_EXTERNAL_STORAGE" >/dev/null 2>&1 &

            # Run test
            bash -lc "set -o pipefail; cd ui_app; timeout 45m flutter test integration_test/app_test.dart --dart-define=USE_GOOGLE_FONTS=false --dart-define=ENABLE_PERMISSIONS=false 2>&1 | tee /tmp/flutter-test.log; test_status=\${PIPESTATUS[0]}; if [ \"\$test_status\" -eq 124 ]; then echo \"flutter test timed out.\"; exit 1; fi; if grep -qi \"0 tests passed\" /tmp/flutter-test.log; then exit 1; fi; if grep -qi \"test failed\" /tmp/flutter-test.log; then exit 1; fi; if grep -qi \"test passed\" /tmp/flutter-test.log || grep -qi \"tests passed\" /tmp/flutter-test.log; then exit 0; fi; echo \"No test summary found in flutter output.\"; exit 1"

      - name: Build Release APK
        if: success() && (github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/'))
        run: |
          cd ui_app
          flutter build apk --release

      - name: Upload Release APK
        if: success() && (github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/'))
        uses: actions/upload-artifact@v4
        with:
          name: idm-open-release-apk
          path: ui_app/build/app/outputs/flutter-apk/app-release.apk
